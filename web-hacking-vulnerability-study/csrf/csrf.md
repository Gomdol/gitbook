# CSRF 대응 방안

대응 방안을 살펴보기 위해, 그 전에 공격이 어떻게 이뤄지는지 순서를 확인한다.



### #CSRF 공격 (중요한 요청에서 파라미터 만들 수 있는지 체크)

1. 중요한 요청 식별
2. 그 요청을 만들 수 있는지 체크
   1. http 파라미터 만들 수 있는지 -> CSRF 취약점 존재.
3. GET Method 체크
4. Link만든 후 클릭하도록 유도



### #대응

#### 1. Mothod 변경

POST Method로만! 처리되도록 구현



***

### <mark style="background-color:orange;">#CSRF 공격 (with post method)</mark>

1. XSS 취약점 찾는다.
2. POST Form Tag



### #대응 (CSRF Token 구현하기!)

요청 데이터 공격자가 미리 세팅할 수 있어서! 발생한거니, <mark style="background-color:blue;">**토큰 추가!**</mark> <mark style="background-color:blue;">**CSRF Token**</mark>



마이페이지에 접속할 때, 랜덤값 생성&#x20;

< hidden > 을 이용하여&#x20;

일련의 랜덤값을 DB 혹은 session에 저장.&#x20;

랜덤값을 마이페이지 안에 넣어서 보내줌.



비밀번호 변경 요청을 받았을 때,&#x20;

저장된 랜덤값과 요청한 사람의 랜덤값을 비교



***

### <mark style="background-color:orange;">#CSRF 공격 (Bypass CSRF Token) XSS iframe</mark>

XSS 존재해야함.

iframe 활용.



iframe으로 해당 페이지에서 토큰을 가져온 후에, 그 토큰을 활용하여 코드를 완성 > 공격



### #대응 (referer header)

referer header에 요청을 보낸 url이 나온다.&#x20;

그 값을 보고 판단할 수 있다.



💡이 요청이 어디에서 온 것인지&#x20;

게시판에서 요청 시 : 레퍼러가 이상하다. 이상한 곳에서 요청한 거라 처리 안 해줄거야.



Referer를 이용한 csrf 막기!

<mark style="color:blue;">Referer 제대로 체크하면 우회가 불가능하다. (Referer는 조작 불가능함.)</mark>



But, Referer 제대로 체크하기가 쉽지 않다.&#x20;

보안을 너무 깐깐히 하면 서비스 하기 쉽지 않다.



***



### #잘못된 예외 처리

<mark style="color:red;">에러가 발생했어 (try catch)</mark>&#x20;

&#x20; \-> 서비스 중단할 수 없으니 / <mark style="background-color:orange;">**눈감아주는 방법(개발자들이 주로 선택함.)**</mark>&#x20;

&#x20; \-&#x20;

&#x20; 내 코드가 서버에 어떤 영향을 끼칠지 판단하기 어렵다.&#x20;

&#x20; \-&#x20;

&#x20; 처음 개발하는 사람 다르고, 나중 개발하는 사람(기능 추가) 다르기 때문임.&#x20;

&#x20; \-&#x20;

&#x20; 이 시스템을 제대로 파악할 수 없기 때문에, 서비스 중단을 선택하기 어렵다.&#x20;

&#x20; (어딘가에서 문제가 터질 수 있어서 무섭다.)



예)&#x20;

**비밀번호 변경**&#x20;

마이페이지 에서만 요청하는 줄 알고 csrf\_ token을 넣어놨다.



개인시크릿페이지에서도 비번 바꾸고 있었다면 <- 여기에도 csrf\_ token 을 넣어야 했다.



change\_pass.php csrf\_ token 파라미터가 없으면 csrf\_ token 검사를 하지 않는다.&#x20;

(이런 방식으로 개발 함.)

#### <mark style="background-color:orange;">일단 csrf 파라미터를 지우고 보내봐라!! (걸릴 확률이 생각보다 많다.)</mark>



예2)&#x20;

referrer를 잘못써서 보내면 잘못되었다고 하지만,&#x20;

referer를 아예 지우고 보냈을 때는 처리가 될 때가 많다.



```html
<meta name="referrer" content="no-referrer">
```

이 코드 한 줄만 쓰면, 우회가 가능함.



***

## #근본적인 대응 방법

<mark style="background-color:blue;">**CSRF 파라미터를 미리 세팅하지 못하게 만들면 됨.**</mark>



<mark style="background-color:blue;">**인증정보**</mark>&#x20;

<mark style="background-color:blue;">**비밀번호, 2차 인증번호 넣도록 하기**</mark>



개인 정보 변경 페이지&#x20;

&#x20;   항상 기존 비밀번호를 <mark style="color:red;">함께 입력</mark> 받기.&#x20;

&#x20;   \> 비밀번호를 사전에 알고 있어야 파라미터 세팅이 가능하나, 해커는 알지 못함.



\- 게시판 글쓰기&#x20;

\- 댓글 남기기&#x20;

\- 채팅할 때&#x20;

이때마다 인증정보를 넣을 수는 없으니,&#x20;

상황에 따라 CSRF Token 등으로 대응하는 게 좋음.





